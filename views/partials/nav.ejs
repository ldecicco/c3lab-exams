<% if (user) { %>
<% const initials = String(user?.username || "")
  .trim()
  .split(/\s+/)
  .filter(Boolean)
  .slice(0, 2)
  .map((part) => part[0].toUpperCase())
  .join("") || "U"; %>
<% const avatarThumbPath = user?.avatarThumbPath
  ? `${String(user.avatarThumbPath).replace(/^\/+/, "")}`
  : ""; %>
<nav class="top-nav">
  <a href="home" class="nav-logo" aria-label="Home">
    <img src="assets/logo.png" alt="Logo" />
  </a>
  <% const role = user?.role || ""; %>
  <% const isAdmin = role === "admin"; %>
  <% const isCreator = role === "creator"; %>
  <% const isEvaluator = role === "evaluator"; %>
  <% const canBuild = isAdmin || isCreator; %>
  <% const canGrade = isAdmin || isCreator || isEvaluator; %>
  <% const canAnalyze = isAdmin || isCreator; %>
  <a href="home" class="nav-link <%= active === 'home' ? 'active' : '' %>">
    <i class="fa-solid fa-graduation-cap"></i>
    Corsi
  </a>
  <% if (canBuild) { %>
    <a href="questions" class="nav-link <%= active === 'questions' ? 'active' : '' %>">
      <i class="fa-solid fa-clipboard-question"></i>
      Domande
    </a>
    <a href="exam-builder" class="nav-link <%= active === 'exam-builder' ? 'active' : '' %>">
      <i class="fa-solid fa-layer-group"></i>
      Tracce
    </a>
  <% } %>
  <a href="valutazione" class="nav-link <%= active === 'valutazione' ? 'active' : '' %>">
    <i class="fa-solid fa-clipboard-check"></i>
    Valutazione
  </a>
  <% if (canAnalyze) { %>
    <a href="dashboard" class="nav-link <%= active === 'dashboard' ? 'active' : '' %>">
      <i class="fa-solid fa-chart-line"></i>
      Analisi
    </a>
  <% } %>
  <div class="nav-spacer"></div>
  <% if (activeExamTitle || activeCourseName) { %>
    <div class="nav-chip-group">
      <% if (activeExamTitle) { %>
        <a class="nav-chip nav-chip-link" href="exam-builder?step=2" title="Apri Domande">
          Traccia: <%= activeExamTitle %>
        </a>
      <% } %>
      <% if (activeCourseName) { %>
        <div class="nav-chip-menu" data-active-course-id="<%= activeCourseId %>">
          <button class="nav-chip nav-chip-button" type="button" id="navCourseToggle" aria-haspopup="true" aria-expanded="false">
            Corso: <%= activeCourseName %>
            <i class="fa-solid fa-chevron-down" aria-hidden="true"></i>
          </button>
          <div class="nav-chip-dropdown is-hidden" id="navCourseDropdown" role="menu">
            <div class="nav-chip-loading">Caricamento...</div>
          </div>
        </div>
      <% } %>
    </div>
  <% } %>
  <button class="nav-avatar" type="button" id="navAvatarButton" aria-haspopup="dialog" aria-label="Foto profilo">
    <img class="nav-avatar-image <%= avatarThumbPath ? '' : 'is-hidden' %>" src="<%= avatarThumbPath %>" alt="" />
    <span class="nav-avatar-initials <%= avatarThumbPath ? 'is-hidden' : '' %>"><%= initials %></span>
  </button>
  <a href="guida" class="nav-link nav-icon <%= active === 'guida' ? 'active' : '' %>" title="Guida" aria-label="Guida">
    <i class="fa-solid fa-circle-question"></i>
  </a>
  <% if (isAdmin) { %>
    <a href="admin" class="nav-link nav-icon admin-link <%= active === 'admin' ? 'active' : '' %>" title="Admin" aria-label="Admin">
      <i class="fa-solid fa-user-gear"></i>
    </a>
  <% } %>
  <a href="logout" class="nav-link nav-icon" title="Esci" aria-label="Esci">
    <i class="fa-solid fa-right-from-bracket"></i>
  </a>
</nav>
<div class="modal-backdrop is-hidden" id="avatarBackdrop"></div>
<div class="modal-panel is-hidden avatar-modal" id="avatarModal" role="dialog" aria-modal="true" aria-labelledby="avatarModalTitle">
  <div class="modal-header">
    <div>
      <h3 class="h5 mb-1" id="avatarModalTitle">Foto profilo</h3>
      <p class="text-secondary mb-0">Carica un'immagine e ritagliala in formato quadrato.</p>
    </div>
    <button class="icon-button" type="button" id="avatarClose" aria-label="Chiudi">
      <i class="fa-solid fa-xmark"></i>
    </button>
  </div>
  <div class="modal-body avatar-modal-body">
    <div class="avatar-upload">
      <div class="avatar-upload-panel">
        <label class="form-label" for="avatarFileInput">Immagine</label>
        <input class="form-control" type="file" id="avatarFileInput" accept="image/*" />
        <div class="avatar-crop-container is-hidden" id="avatarCropContainer">
          <img id="avatarCropImage" alt="Anteprima avatar" />
        </div>
      </div>
      <div class="avatar-upload-panel">
        <div class="avatar-preview-title">Anteprima</div>
        <div class="avatar-preview" id="avatarPreview">
          <span><%= initials %></span>
        </div>
        <p class="text-secondary small">La preview mostra la versione ridotta usata nella navbar.</p>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline-secondary" type="button" id="avatarCancel">Annulla</button>
      <button class="btn btn-outline-secondary" type="button" id="openPasswordModal">
        <i class="fa-solid fa-key"></i>
        Cambia password
      </button>
      <button class="btn btn-outline-secondary" type="button" id="openTwoFaModal">
        <i class="fa-solid fa-shield-halved"></i>
        Gestisci 2FA
      </button>
      <button class="btn btn-primary" type="button" id="avatarSave" disabled>Salva</button>
    </div>
  </div>
</div>
<div class="modal-backdrop is-hidden" id="passwordBackdrop"></div>
<div class="modal-panel is-hidden" id="passwordModal" role="dialog" aria-modal="true" aria-labelledby="passwordModalTitle">
  <div class="modal-header">
    <h3 class="h5 mb-0" id="passwordModalTitle">Cambia password</h3>
    <button class="icon-button" type="button" id="passwordClose" aria-label="Chiudi">
      <i class="fa-solid fa-xmark"></i>
    </button>
  </div>
  <div class="modal-body">
    <div class="vstack gap-3">
      <label class="field">
        <span>Password attuale</span>
        <input id="passwordCurrent" class="form-control" type="password" autocomplete="current-password" />
      </label>
      <label class="field">
        <span>Nuova password</span>
        <input id="passwordNew" class="form-control" type="password" autocomplete="new-password" />
      </label>
      <label class="field">
        <span>Conferma nuova password</span>
        <input id="passwordConfirm" class="form-control" type="password" autocomplete="new-password" />
      </label>
      <div class="text-danger small" id="passwordError" style="min-height: 1.2rem;"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline-secondary" type="button" id="passwordCancel">Annulla</button>
      <button class="btn btn-primary" type="button" id="passwordSave">Aggiorna</button>
    </div>
  </div>
</div>
<div class="modal-backdrop is-hidden" id="twoFaBackdrop"></div>
<div class="modal-panel is-hidden" id="twoFaModal" role="dialog" aria-modal="true" aria-labelledby="twoFaTitle">
  <div class="modal-header">
    <h3 class="h5 mb-0" id="twoFaTitle">Sicurezza 2FA</h3>
    <button class="icon-button" type="button" id="twoFaClose" aria-label="Chiudi">
      <i class="fa-solid fa-xmark"></i>
    </button>
  </div>
  <div class="modal-body">
    <div class="text-secondary mb-3" id="twoFaStatus"></div>
    <div class="vstack gap-3" id="twoFaSetupSection">
      <div class="text-secondary">Scansiona il QR con Google/Microsoft Authenticator.</div>
      <div class="twofa-qr is-hidden" id="twoFaQrWrap">
        <img id="twoFaQr" alt="QR 2FA" />
      </div>
      <div class="text-secondary small" id="twoFaSecret"></div>
      <label class="field">
        <span>Codice 2FA</span>
        <input id="twoFaCode" class="form-control" type="text" inputmode="numeric" autocomplete="one-time-code" />
      </label>
      <div class="actions">
        <button class="btn btn-primary" type="button" id="twoFaVerify">Conferma</button>
      </div>
    </div>
    <div class="vstack gap-3 is-hidden" id="twoFaDisableSection">
      <label class="field">
        <span>Password attuale</span>
        <input id="twoFaDisablePassword" class="form-control" type="password" autocomplete="current-password" />
      </label>
      <div class="actions">
        <button class="btn btn-outline-secondary" type="button" id="twoFaDisable">Disabilita 2FA</button>
      </div>
    </div>
    <div class="text-danger small" id="twoFaError" style="min-height: 1.2rem;"></div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-outline-secondary" type="button" id="twoFaStart">Attiva 2FA</button>
    <button class="btn btn-outline-secondary" type="button" id="twoFaCancel">Chiudi</button>
  </div>
</div>
<script>
  (() => {
    const meta = document.querySelector('meta[name="csrf-token"]');
    if (!meta) return;
    const token = meta.getAttribute("content");
    if (!token) return;
    const originalFetch = window.fetch;
    window.fetch = function (resource, options = {}) {
      const opts = options || {};
      const method = String(opts.method || "GET").toUpperCase();
      const url = typeof resource === "string" ? resource : resource?.url || "";
      let sameOrigin = true;
      if (url && (url.startsWith("http://") || url.startsWith("https://"))) {
        try {
          const parsed = new URL(url);
          sameOrigin = parsed.origin === window.location.origin;
        } catch {
          sameOrigin = false;
        }
      }
      if (sameOrigin && !["GET", "HEAD", "OPTIONS"].includes(method)) {
        if (opts.headers instanceof Headers) {
          if (!opts.headers.has("X-CSRF-Token")) {
            opts.headers.set("X-CSRF-Token", token);
          }
        } else {
          opts.headers = opts.headers || {};
          if (!("X-CSRF-Token" in opts.headers)) {
            opts.headers["X-CSRF-Token"] = token;
          }
        }
      }
      return originalFetch(resource, opts);
    };
  })();
</script>
<% if (activeCourseName) { %>
  <script>
    (() => {
      const toggle = document.getElementById("navCourseToggle");
      const dropdown = document.getElementById("navCourseDropdown");
      const menu = document.querySelector(".nav-chip-menu");
      if (!toggle || !dropdown || !menu) return;
      let loaded = false;
      const activeId = Number(menu.dataset.activeCourseId || "");

      const close = () => {
        dropdown.classList.add("is-hidden");
        toggle.setAttribute("aria-expanded", "false");
      };

      const render = (courses) => {
        dropdown.innerHTML = "";
        if (!courses.length) {
          const empty = document.createElement("div");
          empty.className = "nav-chip-empty";
          empty.textContent = "Nessun corso disponibile.";
          dropdown.appendChild(empty);
          return;
        }
        courses.forEach((course) => {
          const item = document.createElement("button");
          item.type = "button";
          item.className = "nav-chip-item";
          item.textContent = course.name || "Corso";
          if (Number(course.id) === activeId) {
            item.classList.add("is-active");
          }
          item.addEventListener("click", async () => {
            try {
              await fetch("api/session/course", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ courseId: course.id }),
              });
              window.location.reload();
            } catch {
              close();
            }
          });
          dropdown.appendChild(item);
        });
      };

      const open = async () => {
        dropdown.classList.remove("is-hidden");
        toggle.setAttribute("aria-expanded", "true");
        if (loaded) return;
        try {
          const res = await fetch("api/courses");
          const payload = await res.json();
          render(payload.courses || []);
        } catch {
          render([]);
        }
        loaded = true;
      };

      toggle.addEventListener("click", (event) => {
        event.stopPropagation();
        if (dropdown.classList.contains("is-hidden")) {
          open();
        } else {
          close();
        }
      });

      document.addEventListener("click", (event) => {
        if (!menu.contains(event.target)) close();
      });
    })();
  </script>
<% } %>
<script>
  (() => {
    const openButton = document.getElementById("navAvatarButton");
    const modal = document.getElementById("avatarModal");
    const backdrop = document.getElementById("avatarBackdrop");
    const closeButton = document.getElementById("avatarClose");
    const cancelButton = document.getElementById("avatarCancel");
    const fileInput = document.getElementById("avatarFileInput");
    const cropContainer = document.getElementById("avatarCropContainer");
    const cropImage = document.getElementById("avatarCropImage");
    const saveButton = document.getElementById("avatarSave");
    const preview = document.getElementById("avatarPreview");
    const passwordBackdrop = document.getElementById("passwordBackdrop");
    const passwordModal = document.getElementById("passwordModal");
    const passwordClose = document.getElementById("passwordClose");
    const passwordCancel = document.getElementById("passwordCancel");
    const passwordSave = document.getElementById("passwordSave");
    const passwordCurrent = document.getElementById("passwordCurrent");
    const passwordNew = document.getElementById("passwordNew");
    const passwordConfirm = document.getElementById("passwordConfirm");
    const passwordError = document.getElementById("passwordError");
    const openPasswordModal = document.getElementById("openPasswordModal");
    const openTwoFaModal = document.getElementById("openTwoFaModal");
    const twoFaBackdrop = document.getElementById("twoFaBackdrop");
    const twoFaModal = document.getElementById("twoFaModal");
    const twoFaClose = document.getElementById("twoFaClose");
    const twoFaCancel = document.getElementById("twoFaCancel");
    const twoFaStatus = document.getElementById("twoFaStatus");
    const twoFaStart = document.getElementById("twoFaStart");
    const twoFaVerify = document.getElementById("twoFaVerify");
    const twoFaDisable = document.getElementById("twoFaDisable");
    const twoFaError = document.getElementById("twoFaError");
    const twoFaSetupSection = document.getElementById("twoFaSetupSection");
    const twoFaDisableSection = document.getElementById("twoFaDisableSection");
    const twoFaQrWrap = document.getElementById("twoFaQrWrap");
    const twoFaQr = document.getElementById("twoFaQr");
    const twoFaSecret = document.getElementById("twoFaSecret");
    const twoFaCode = document.getElementById("twoFaCode");
    const twoFaDisablePassword = document.getElementById("twoFaDisablePassword");
    let twoFaEnabled = <%= user?.totpEnabled ? 'true' : 'false' %>;
    if (!openButton || !modal || !backdrop || !fileInput || !cropImage || !saveButton || !preview) return;

    let cropper = null;
    let originalBase64 = "";
    let originalName = "";

    const showToast = (message, tone) => {
      if (typeof window.showToast === "function") {
        window.showToast(message, tone);
        return;
      }
      let toast = document.querySelector(".toast-notify");
      if (!toast) {
        toast = document.createElement("div");
        toast.className = "toast-notify";
        document.body.appendChild(toast);
      }
      toast.textContent = message;
      toast.classList.remove("is-error", "is-success");
      if (tone === "error") toast.classList.add("is-error");
      if (tone === "success") toast.classList.add("is-success");
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 2400);
    };

    const loadCropper = (() => {
      let promise = null;
      return () => {
        if (window.Cropper) return Promise.resolve();
        if (promise) return promise;
        promise = new Promise((resolve, reject) => {
          const link = document.createElement("link");
          link.rel = "stylesheet";
          link.href = "https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.css";
          document.head.appendChild(link);
          const script = document.createElement("script");
          script.src = "https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.js";
          script.onload = () => resolve();
          script.onerror = () => reject(new Error("Cropper load failed"));
          document.body.appendChild(script);
        });
        return promise;
      };
    })();

    const openModal = () => {
      modal.classList.remove("is-hidden");
      backdrop.classList.remove("is-hidden");
    };

    const closeModal = () => {
      modal.classList.add("is-hidden");
      backdrop.classList.add("is-hidden");
    };

    const resetCropper = () => {
      if (cropper) {
        cropper.destroy();
        cropper = null;
      }
      cropContainer.classList.add("is-hidden");
      cropImage.src = "";
      fileInput.value = "";
      originalBase64 = "";
      originalName = "";
      saveButton.disabled = true;
    };

    const closePasswordModal = () => {
      if (passwordBackdrop) passwordBackdrop.classList.add("is-hidden");
      if (passwordModal) passwordModal.classList.add("is-hidden");
      if (passwordError) passwordError.textContent = "";
      if (passwordCurrent) passwordCurrent.value = "";
      if (passwordNew) passwordNew.value = "";
      if (passwordConfirm) passwordConfirm.value = "";
    };

    const openTwoFa = () => {
      if (twoFaBackdrop) twoFaBackdrop.classList.remove("is-hidden");
      if (twoFaModal) twoFaModal.classList.remove("is-hidden");
      if (twoFaError) twoFaError.textContent = "";
      if (twoFaCode) twoFaCode.value = "";
      if (twoFaDisablePassword) twoFaDisablePassword.value = "";
      if (twoFaQrWrap) twoFaQrWrap.classList.add("is-hidden");
      if (twoFaSecret) twoFaSecret.textContent = "";
      if (twoFaSetupSection) twoFaSetupSection.classList.add("is-hidden");
      updateTwoFaView();
    };

    const closeTwoFa = () => {
      if (twoFaBackdrop) twoFaBackdrop.classList.add("is-hidden");
      if (twoFaModal) twoFaModal.classList.add("is-hidden");
      if (twoFaError) twoFaError.textContent = "";
    };

    const updateTwoFaView = () => {
      if (twoFaStatus) {
        twoFaStatus.textContent = twoFaEnabled
          ? "2FA attivo: richiesto al login."
          : "2FA non attivo.";
      }
      if (twoFaDisableSection) {
        twoFaDisableSection.classList.toggle("is-hidden", !twoFaEnabled);
      }
      if (twoFaStart) {
        twoFaStart.disabled = twoFaEnabled;
      }
      if (twoFaSetupSection) {
        if (twoFaEnabled) {
          twoFaSetupSection.classList.add("is-hidden");
        }
      }
    };

    if (openPasswordModal) {
      openPasswordModal.addEventListener("click", () => {
        if (passwordBackdrop) passwordBackdrop.classList.remove("is-hidden");
        if (passwordModal) passwordModal.classList.remove("is-hidden");
      });
    }
    if (openTwoFaModal) openTwoFaModal.addEventListener("click", openTwoFa);
    if (twoFaClose) twoFaClose.addEventListener("click", closeTwoFa);
    if (twoFaCancel) twoFaCancel.addEventListener("click", closeTwoFa);
    if (twoFaBackdrop) {
      twoFaBackdrop.addEventListener("click", (event) => {
        if (event.target === twoFaBackdrop) closeTwoFa();
      });
    }
    if (passwordClose) passwordClose.addEventListener("click", closePasswordModal);
    if (passwordCancel) passwordCancel.addEventListener("click", closePasswordModal);
    if (passwordBackdrop) {
      passwordBackdrop.addEventListener("click", (event) => {
        if (event.target === passwordBackdrop) closePasswordModal();
      });
    }
    if (passwordSave) {
      passwordSave.addEventListener("click", async () => {
        if (passwordError) passwordError.textContent = "";
        const current = String(passwordCurrent?.value || "");
        const next = String(passwordNew?.value || "");
        const confirm = String(passwordConfirm?.value || "");
        if (!current || !next || !confirm) {
          if (passwordError) passwordError.textContent = "Compila tutti i campi.";
          return;
        }
        if (next.length < 8 || !/\d/.test(next)) {
          if (passwordError) {
            passwordError.textContent = "La nuova password deve avere almeno 8 caratteri e un numero.";
          }
          return;
        }
        if (next !== confirm) {
          if (passwordError) passwordError.textContent = "Le password non coincidono.";
          return;
        }
        try {
          const res = await fetch("api/users/me/password", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ currentPassword: current, newPassword: next }),
          });
          const data = await res.json();
          if (!res.ok) {
            throw new Error(data.error || "Errore aggiornamento password");
          }
          showToast("Password aggiornata.", "success");
          closePasswordModal();
        } catch (err) {
          if (passwordError) passwordError.textContent = err.message || "Errore aggiornamento password.";
        }
      });
    }

    if (twoFaStart) {
      twoFaStart.addEventListener("click", async () => {
        if (twoFaError) twoFaError.textContent = "";
        try {
          const res = await fetch("api/2fa/setup/start", { method: "POST" });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) throw new Error(data.error || "Errore 2FA");
          if (twoFaSetupSection) twoFaSetupSection.classList.remove("is-hidden");
          if (twoFaQrWrap) twoFaQrWrap.classList.toggle("is-hidden", !data.qrCodeDataUrl);
          if (twoFaQr && data.qrCodeDataUrl) twoFaQr.src = data.qrCodeDataUrl;
          if (twoFaSecret) twoFaSecret.textContent = data.secret ? `Chiave: ${data.secret}` : "";
          if (twoFaCode) twoFaCode.focus();
        } catch (err) {
          if (twoFaError) twoFaError.textContent = err.message || "Errore 2FA";
        }
      });
    }

    if (twoFaVerify) {
      twoFaVerify.addEventListener("click", async () => {
        if (twoFaError) twoFaError.textContent = "";
        const token = String(twoFaCode?.value || "").trim();
        if (!token) {
          if (twoFaError) twoFaError.textContent = "Inserisci il codice.";
          return;
        }
        try {
          const res = await fetch("api/2fa/setup/verify", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token }),
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) throw new Error(data.error || "Errore 2FA");
          twoFaEnabled = true;
          updateTwoFaView();
          showToast("2FA attivo.", "success");
          if (twoFaSetupSection) twoFaSetupSection.classList.add("is-hidden");
        } catch (err) {
          if (twoFaError) twoFaError.textContent = err.message || "Errore 2FA";
        }
      });
    }

    if (twoFaDisable) {
      twoFaDisable.addEventListener("click", async () => {
        if (twoFaError) twoFaError.textContent = "";
        const password = String(twoFaDisablePassword?.value || "");
        if (!password) {
          if (twoFaError) twoFaError.textContent = "Inserisci la password.";
          return;
        }
        try {
          const res = await fetch("api/2fa/disable", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ password }),
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) throw new Error(data.error || "Errore 2FA");
          twoFaEnabled = false;
          updateTwoFaView();
          showToast("2FA disattivato.", "success");
        } catch (err) {
          if (twoFaError) twoFaError.textContent = err.message || "Errore 2FA";
        }
      });
    }

    const updatePreview = (dataUrl) => {
      preview.innerHTML = "";
      const img = document.createElement("img");
      img.src = dataUrl;
      img.alt = "";
      preview.appendChild(img);
    };

    openButton.addEventListener("click", () => {
      openModal();
    });

    [backdrop, closeButton, cancelButton].forEach((el) => {
      if (!el) return;
      el.addEventListener("click", () => {
        closeModal();
        resetCropper();
      });
    });

    fileInput.addEventListener("change", async (event) => {
      const file = event.target.files?.[0];
      if (!file) return;
      originalName = file.name;
      const reader = new FileReader();
      reader.onload = async () => {
        originalBase64 = String(reader.result || "");
        cropImage.src = originalBase64;
        cropContainer.classList.remove("is-hidden");
        saveButton.disabled = false;
        try {
          await loadCropper();
        } catch (err) {
          showToast("Impossibile caricare il cropper.", "error");
          return;
        }
        if (cropper) cropper.destroy();
        cropper = new window.Cropper(cropImage, {
          aspectRatio: 1,
          viewMode: 1,
          autoCropArea: 1,
          background: false,
          responsive: true,
          crop: () => {
            if (!cropper) return;
            const canvas = cropper.getCroppedCanvas({ width: 256, height: 256 });
            updatePreview(canvas.toDataURL("image/png"));
          },
        });
      };
      reader.readAsDataURL(file);
    });

    saveButton.addEventListener("click", async () => {
      if (!cropper || !originalBase64) return;
      try {
        const croppedBase64 = cropper
          .getCroppedCanvas({ width: 256, height: 256 })
          .toDataURL("image/png");
        const res = await fetch("api/users/me/avatar", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ originalBase64, croppedBase64, originalName }),
        });
        const data = await res.json();
        if (!res.ok) {
          throw new Error(data.error || "Errore upload avatar");
        }
        const avatarImg = document.querySelector(".nav-avatar-image");
        const avatarInitials = document.querySelector(".nav-avatar-initials");
        if (avatarImg && data.avatar_thumb_path) {
          avatarImg.src = `/${String(data.avatar_thumb_path).replace(/^\/+/, "")}`;
          avatarImg.classList.remove("is-hidden");
        }
        if (avatarInitials) {
          avatarInitials.classList.add("is-hidden");
        }
        showToast("Foto profilo aggiornata.", "success");
        closeModal();
        resetCropper();
      } catch (err) {
        showToast(err.message || "Errore upload avatar.", "error");
      }
    });
  })();
</script>
<% } %>
