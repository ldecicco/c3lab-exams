<% if (user) { %>
<% const initials = String(user?.username || "")
  .trim()
  .split(/\s+/)
  .filter(Boolean)
  .slice(0, 2)
  .map((part) => part[0].toUpperCase())
  .join("") || "U"; %>
<% const avatarThumbPath = user?.avatarThumbPath
  ? `${String(user.avatarThumbPath).replace(/^\/+/, "")}`
  : ""; %>
<nav class="top-nav">
  <a href="home" class="nav-logo" aria-label="Home">
    <img src="assets/logo.png" alt="Logo" />
  </a>
  <% const role = user?.role || ""; %>
  <% const isAdmin = role === "admin"; %>
  <% const isCreator = role === "creator"; %>
  <% const isEvaluator = role === "evaluator"; %>
  <% const canBuild = isAdmin || isCreator; %>
  <% const canGrade = isAdmin || isCreator || isEvaluator; %>
  <% const canAnalyze = isAdmin || isCreator; %>
  <a href="home" class="nav-link <%= active === 'home' ? 'active' : '' %>">
    <i class="fa-solid fa-graduation-cap"></i>
    Corsi
  </a>
  <% if (canBuild) { %>
    <a href="questions" class="nav-link <%= active === 'questions' ? 'active' : '' %>">
      <i class="fa-solid fa-clipboard-question"></i>
      Domande
    </a>
    <a href="exam-builder" class="nav-link <%= active === 'exam-builder' ? 'active' : '' %>">
      <i class="fa-solid fa-layer-group"></i>
      Tracce
    </a>
  <% } %>
  <a href="valutazione" class="nav-link <%= active === 'valutazione' ? 'active' : '' %>">
    <i class="fa-solid fa-clipboard-check"></i>
    Valutazione
  </a>
  <% if (canAnalyze) { %>
  <a href="dashboard" class="nav-link <%= active === 'dashboard' ? 'active' : '' %>">
    <i class="fa-solid fa-chart-line"></i>
    Analisi
  </a>
  <a href="esame-completo" class="nav-link <%= active === 'esame-completo' ? 'active' : '' %>">
    <i class="fa-solid fa-link"></i>
    Esame completo
  </a>
  <% } %>
  <div class="nav-spacer"></div>
  <% if (activeExamTitle || activeCourseName) { %>
    <div class="nav-chip-group">
      <% if (activeExamTitle) { %>
        <a class="nav-chip nav-chip-link" href="exam-builder?step=2" title="Apri Domande">
          Traccia: <%= activeExamTitle %>
        </a>
      <% } %>
      <% if (activeCourseName) { %>
        <div class="nav-chip-menu" data-active-course-id="<%= activeCourseId %>">
          <button class="nav-chip nav-chip-button" type="button" id="navCourseToggle" aria-haspopup="true" aria-expanded="false">
            Corso: <%= activeCourseName %>
            <i class="fa-solid fa-chevron-down" aria-hidden="true"></i>
          </button>
          <div class="nav-chip-dropdown is-hidden" id="navCourseDropdown" role="menu">
            <div class="nav-chip-loading">Caricamento...</div>
          </div>
        </div>
      <% } %>
    </div>
  <% } %>
  <button class="nav-avatar" type="button" id="navAvatarButton" aria-haspopup="dialog" aria-label="Foto profilo">
    <img class="nav-avatar-image <%= avatarThumbPath ? '' : 'is-hidden' %>" src="<%= avatarThumbPath %>" alt="" />
    <span class="nav-avatar-initials <%= avatarThumbPath ? 'is-hidden' : '' %>"><%= initials %></span>
  </button>
  <a href="guida" class="nav-link nav-icon <%= active === 'guida' ? 'active' : '' %>" title="Guida" aria-label="Guida">
    <i class="fa-solid fa-circle-question"></i>
  </a>
  <% if (isAdmin) { %>
    <a href="admin" class="nav-link nav-icon admin-link <%= active === 'admin' ? 'active' : '' %>" title="Admin" aria-label="Admin">
      <i class="fa-solid fa-user-gear"></i>
    </a>
  <% } %>
  <a href="logout" class="nav-link nav-icon" title="Esci" aria-label="Esci">
    <i class="fa-solid fa-right-from-bracket"></i>
  </a>
</nav>
<div class="modal-backdrop is-hidden" id="avatarBackdrop"></div>
<div class="modal-panel is-hidden avatar-modal" id="avatarModal" role="dialog" aria-modal="true" aria-labelledby="avatarModalTitle">
  <div class="modal-header">
    <div>
      <h3 class="h5 mb-1" id="avatarModalTitle">Foto profilo</h3>
      <p class="text-secondary mb-0">Carica un'immagine e ritagliala in formato quadrato.</p>
    </div>
    <button class="icon-button" type="button" id="avatarClose" aria-label="Chiudi">
      <i class="fa-solid fa-xmark"></i>
    </button>
  </div>
  <div class="modal-body avatar-modal-body">
    <div class="avatar-upload">
      <div class="avatar-upload-panel">
        <label class="form-label" for="avatarFileInput">Immagine</label>
        <input class="form-control" type="file" id="avatarFileInput" accept="image/*" />
        <div class="avatar-crop-container is-hidden" id="avatarCropContainer">
          <img id="avatarCropImage" alt="Anteprima avatar" />
        </div>
      </div>
      <div class="avatar-upload-panel">
        <div class="avatar-preview-title">Anteprima</div>
        <div class="avatar-preview" id="avatarPreview">
          <span><%= initials %></span>
        </div>
        <p class="text-secondary small">La preview mostra la versione ridotta usata nella navbar.</p>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline-secondary" type="button" id="avatarCancel">Annulla</button>
      <button class="btn btn-outline-secondary" type="button" id="openPasswordModal">
        <i class="fa-solid fa-key"></i>
        Cambia password
      </button>
      <button class="btn btn-outline-secondary" type="button" id="openTwoFaModal">
        <i class="fa-solid fa-shield-halved"></i>
        Gestisci 2FA
      </button>
      <button class="btn btn-primary" type="button" id="avatarSave" disabled>Salva</button>
    </div>
  </div>
</div>
<div class="modal-backdrop is-hidden" id="passwordBackdrop"></div>
<div class="modal-panel is-hidden" id="passwordModal" role="dialog" aria-modal="true" aria-labelledby="passwordModalTitle">
  <div class="modal-header">
    <h3 class="h5 mb-0" id="passwordModalTitle">Cambia password</h3>
    <button class="icon-button" type="button" id="passwordClose" aria-label="Chiudi">
      <i class="fa-solid fa-xmark"></i>
    </button>
  </div>
  <div class="modal-body">
    <div class="vstack gap-3">
      <label class="field">
        <span>Password attuale</span>
        <input id="passwordCurrent" class="form-control" type="password" autocomplete="current-password" />
      </label>
      <label class="field">
        <span>Nuova password</span>
        <input id="passwordNew" class="form-control" type="password" autocomplete="new-password" />
      </label>
      <label class="field">
        <span>Conferma nuova password</span>
        <input id="passwordConfirm" class="form-control" type="password" autocomplete="new-password" />
      </label>
      <div class="text-danger small" id="passwordError" style="min-height: 1.2rem;"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline-secondary" type="button" id="passwordCancel">Annulla</button>
      <button class="btn btn-primary" type="button" id="passwordSave">Aggiorna</button>
    </div>
  </div>
</div>
<div class="twofa-lock is-hidden" id="twoFaLock"></div>
<div class="modal-backdrop is-hidden" id="twoFaBackdrop"></div>
<div class="modal-panel is-hidden" id="twoFaModal" role="dialog" aria-modal="true" aria-labelledby="twoFaTitle">
  <div class="modal-header">
    <h3 class="h5 mb-0" id="twoFaTitle">Sicurezza 2FA</h3>
    <button class="icon-button" type="button" id="twoFaClose" aria-label="Chiudi">
      <i class="fa-solid fa-xmark"></i>
    </button>
  </div>
  <div class="modal-body">
    <div class="text-secondary mb-3" id="twoFaStatus"></div>
    <div class="vstack gap-3" id="twoFaSetupSection">
      <div class="text-secondary">Scansiona il QR con Google/Microsoft Authenticator.</div>
      <div class="twofa-qr is-hidden" id="twoFaQrWrap">
        <img id="twoFaQr" alt="QR 2FA" />
      </div>
      <div class="text-secondary small" id="twoFaSecret"></div>
      <label class="field">
        <span>Codice 2FA</span>
        <input id="twoFaCode" class="form-control" type="text" inputmode="numeric" autocomplete="one-time-code" />
      </label>
      <div class="actions">
        <button class="btn btn-primary" type="button" id="twoFaVerify">Conferma</button>
      </div>
    </div>
    <div class="vstack gap-3 is-hidden" id="twoFaDisableSection">
      <label class="field">
        <span>Password attuale</span>
        <input id="twoFaDisablePassword" class="form-control" type="password" autocomplete="current-password" />
      </label>
      <div class="actions">
        <button class="btn btn-outline-secondary" type="button" id="twoFaDisable">Disabilita 2FA</button>
      </div>
    </div>
    <div class="text-danger small" id="twoFaError" style="min-height: 1.2rem;"></div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-outline-secondary" type="button" id="twoFaStart">Attiva 2FA</button>
    <button class="btn btn-outline-secondary" type="button" id="twoFaCancel">Chiudi</button>
  </div>
</div>
<script defer src="utils/ui.js?v=1"></script>
<script defer src="nav.js?v=1"></script>
<% } %>
