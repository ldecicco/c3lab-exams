<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <% if (csrfToken) { %><meta name="csrf-token" content="<%= csrfToken %>"><% } %>
    <base href="<%= basePath %>/" />
    <title>Registro Esami - Fondamenti di Automatica</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <script>
      window.APP_USER = <%- JSON.stringify(user || null) %>;
    </script>
    <%- include('partials/nav', { active: 'valutazione' }) %>
    <div class="bg-orbit"></div>
    <div class="bg-grid"></div>

    <div class="empty-state is-hidden" id="courseEmptyState">
      <div class="empty-state-content">
        <strong>Seleziona un corso per iniziare</strong>
        <a class="btn btn-primary" href="home">
          <i class="fa-solid fa-graduation-cap"></i>
          Vai ai corsi
        </a>
      </div>
    </div>

    <main class="layout container-fluid admin-layout py-4" id="mainLayout">
      <% if (user) { %>
      <div class="builder-topbar grading-topbar">
        <div class="builder-topbar-left">
          <button class="btn btn-outline-secondary" id="topbarSelectExam" type="button">
            <i class="fa-solid fa-list-check"></i>
            Seleziona traccia
          </button>
          <button class="btn btn-outline-secondary" id="topbarImportEsse3" type="button">
            <i class="fa-solid fa-file-import"></i>
            Importa lista
          </button>
          <button class="btn btn-outline-primary" id="topbarExportXls" type="button">
            <i class="fa-regular fa-file-excel"></i>
            Genera XLS
          </button>
          <button class="btn btn-outline-danger" id="topbarClear" type="button">
            <i class="fa-solid fa-trash-can"></i>
            Svuota registro
          </button>
          <button class="btn btn-outline-secondary" id="topbarTeachingPrompt" type="button" title="Genera prompt AI per migliorare l'insegnamento">
            <i class="fa-solid fa-chalkboard-user"></i>
            Consigli didattici
          </button>
        </div>
        <div class="builder-topbar-right">
          <span class="toolbar-status" id="mappingBadge">Nessuna traccia</span>
          <span class="toolbar-status" id="publicAccessSummary"></span>
        </div>
      </div>
      <div class="empty-state" id="examEmptyState">
        <div class="empty-state-content">
          <strong>Seleziona una traccia per iniziare</strong>
          <button class="btn btn-primary" type="button" id="emptySelectExam">
            <i class="fa-solid fa-list-check"></i>
            Seleziona traccia
          </button>
        </div>
      </div>
      <div class="empty-state is-hidden" id="examLockedState">
        <div class="empty-state-content">
          <strong>Traccia non chiusa</strong>
          <div class="text-secondary">
            Chiudi la traccia prima di procedere con la valutazione.
          </div>
          <a class="btn btn-outline-primary mt-2" href="exam-builder">
            Vai a Tracce
          </a>
        </div>
      </div>

      <section class="card shadow-sm mb-4 exam-section">
        <div class="card-header">
          <div class="card-header-row">
            <div>
              <h2 class="h5 mb-1">Valutazione studente</h2>
            </div>
            <div class="header-actions">
              <input id="esse3File" class="form-control visually-hidden" type="file" accept=".xls" />
              <button id="importEsse3" class="btn btn-outline-primary" type="button">
                <i class="fa-solid fa-file-import"></i>
                Importa lista
              </button>
            </div>
          </div>
        </div>
        <form id="studentForm">
          <div class="row g-3">
            <label class="field col-md-3">
              <span>Matricola</span>
              <input id="matricola" class="form-control" type="text" required />
            </label>
            <label class="field col-md-3">
              <span>Nome</span>
              <input id="nome" class="form-control" type="text" required />
            </label>
            <label class="field col-md-3">
              <span>Cognome</span>
              <input id="cognome" class="form-control" type="text" required />
            </label>
            <label class="field col-md-3">
              <span>Versione compito</span>
              <input id="versione" class="form-control" type="number" min="1" required />
            </label>
          </div>

          <div class="answers-header">
            <h3 class="h6 mb-1">Risposte</h3>
            <p class="text-secondary small mb-0">Seleziona una o piu risposte per domanda.</p>
          </div>
          <div id="answersGrid" class="answers-grid"></div>

          <div class="actions">
            <button type="submit" class="btn btn-primary">Aggiungi studente</button>
            <button type="button" class="btn btn-outline-secondary" id="resetForm">Reset</button>
          </div>
        </form>
      </section>

      <section class="card shadow-sm mb-4 exam-section">
        <details class="session-panel" open>
          <summary>Lista studenti</summary>
          <div class="students-toolbar mt-3">
            <div class="students-title-row">
              <div class="toolbar-search">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input id="studentSearch" class="form-control" type="text" placeholder="Cerca studente" />
              </div>
            </div>
            <div class="students-toolbar-actions">
              <div class="student-progress compact-metric">
                <span class="metric-label">Completamento</span>
                <div class="progress">
                  <div id="gradingProgress" class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <span class="text-secondary small" id="gradingProgressLabel">0%</span>
              </div>
              <div class="toolbar-metric">
                <span class="metric-label">Voto normaliz.</span>
                <input id="targetTopGrade" class="form-control toolbar-input" type="number" step="0.1" min="0" value="30" />
              </div>
              <div class="metric-value">
                <span class="metric-label">Migliore attuale</span>
                <span id="currentTopGradeBadge" class="metric-number">-</span>
              </div>
              <button class="btn btn-outline-primary" id="recalcNormalized" type="button">
                <i class="fa-solid fa-rotate"></i>
                Ricalcola
              </button>
            </div>
          </div>
          <div class="table-wrap mt-3">
            <table class="table table-striped table-sm align-middle students-table">
              <thead>
                <tr>
                  <th>Matricola</th>
                  <th>Cognome</th>
                  <th>Nome</th>
                  <th>Versione</th>
                  <th>Risposte</th>
                  <th>Punti</th>
                  <th>Voto / 30</th>
                  <th>Voto norm.</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="studentsTable"></tbody>
            </table>
          </div>
        </details>
      </section>

      <section class="card shadow-sm exam-section">
        <div class="card-header">
          <h2 class="h5 mb-1">Impostazioni pubblicazione risultati</h2>
        </div>

        <div class="grading-controls">
          <label class="field">
            <span>Data risultati</span>
            <input id="resultDate" class="form-control" type="date" />
          </label>
          <div class="grading-factor text-secondary" id="gradingFactor">Fattore: -</div>
        </div>
        <div class="public-access" id="publicAccessControls">
          <div class="public-access-header">
            <h3 class="h6 mb-0">Accesso studenti</h3>
            <button class="btn btn-outline-primary btn-sm public-access-toggle-btn" type="button" id="publicAccessToggleBtn">
              Abilita accesso
            </button>
          </div>
          <div class="public-access-body" id="publicAccessFields">
            <label class="field">
              <span>Password traccia</span>
              <input
                id="publicAccessPassword"
                class="form-control"
                type="text"
                placeholder="Imposta una nuova password"
              />
            </label>
            <label class="field">
              <span>Scadenza accesso</span>
              <input id="publicAccessExpiresAt" class="form-control" type="date" />
            </label>
            <label class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="publicAccessShowNotes" />
              <span class="form-check-label">Mostra note</span>
            </label>
            <button class="btn btn-outline-primary" type="button" id="publicAccessSave">
              Salva accesso
            </button>
          </div>
        </div>
    
        <div class="actions">
          <button class="btn btn-outline-primary" id="exportResultsXls">Genera XLS risultati</button>
        </div>
        <div class="compact-controls">
          <div class="compact-row">
            <label class="field">
              <span>Lista studenti (.xls) per export</span>
              <input id="esse3ResultsFile" class="form-control" type="file" accept=".xls" />
            </label>
          </div>
        </div>
      </section>
      <% } else { %>
      <section class="card shadow-sm public-access-card">
        <div class="public-access-logo">
          <img src="assets/logo.png" alt="Logo" />
        </div>
        <div class="card-header" id="publicAccessHeader">
          <h2 class="h5 mb-1" id="publicAccessHeaderTitle">Seleziona il corso</h2>
          <p class="text-secondary mb-0" id="publicAccessHeaderSubtitle">
            Scegli il corso per visualizzare le tracce disponibili.
          </p>
        </div>
        <div class="card-body">
          <div class="exam-grid" id="publicCourseGrid"></div>
          <div id="publicExamSection" class="is-hidden">
            <button class="btn btn-outline-secondary btn-sm mb-3" type="button" id="backToCourses">
              <i class="fa-solid fa-arrow-left"></i>
              Torna ai corsi
            </button>
            <div class="exam-grid" id="publicExamGrid"></div>
          </div>
          <div id="publicResultWrap" class="mt-4 is-hidden">
            <div class="print-logo">
              <img src="assets/logo.png" alt="Logo" />
            </div>
            <div class="d-flex flex-wrap gap-3 align-items-center mb-3">
              <h3 class="h6 mb-0" id="publicResultTitle"></h3>
              <span class="chip" id="publicResultGrade"></span>
              <button class="btn btn-outline-primary btn-sm is-hidden" type="button" id="publicPrintResult">
                Stampa
              </button>
            </div>
            <div id="publicResultMeta" class="text-secondary small mb-3"></div>
            <div id="publicResultQuestions" class="vstack gap-3"></div>
          </div>
        </div>
      </section>
      <div class="modal-backdrop is-hidden" id="publicAccessBackdrop"></div>
      <div class="modal-panel is-hidden" id="publicAccessModal" role="dialog" aria-modal="true" aria-labelledby="publicAccessTitle" style="max-width: 400px;">
        <div class="modal-header">
          <h3 class="h5 mb-0" id="publicAccessTitle">Accesso traccia</h3>
          <button class="btn btn-outline-secondary btn-icon btn-sm" type="button" id="publicAccessClose" aria-label="Chiudi">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <div class="modal-body">
          <form id="publicAccessForm" class="vstack gap-3">
            <label class="field">
              <span>Matricola</span>
              <input id="publicMatricola" class="form-control" type="text" required />
            </label>
            <label class="field">
              <span>Password traccia</span>
              <div class="input-group">
                <input id="publicPassword" class="form-control" type="password" required />
                <button class="btn btn-outline-secondary" type="button" id="publicPasswordToggle" aria-label="Mostra password">
                  <i class="fa-regular fa-eye"></i>
                </button>
              </div>
            </label>
            <div>
              <button class="btn btn-primary w-100" type="submit">Mostra risultato</button>
            </div>
          </form>
          <div class="text-danger mt-3" id="publicAccessError" style="min-height: 1.5rem; font-weight: 500;"></div>
        </div>
      </div>
      <% } %>
    </main>

    <% if (user) { %>
    <div class="modal-backdrop is-hidden" id="examPreviewBackdrop"></div>
    <div class="modal-panel is-hidden" id="examPreviewModal" role="dialog" aria-modal="true" aria-labelledby="examPreviewTitle">
      <div class="modal-header">
        <h3 class="h5 mb-0" id="examPreviewTitle">Anteprima esercizio</h3>
        <button class="btn btn-outline-secondary btn-icon btn-sm" type="button" id="examPreviewClose" aria-label="Chiudi">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="question-preview" id="examPreviewBody"></div>
      </div>
    </div>

    <div class="modal-backdrop is-hidden" id="examHistoryBackdrop"></div>
    <div class="modal-panel is-hidden" id="examHistoryModal" role="dialog" aria-modal="true" aria-labelledby="examHistoryTitle">
      <div class="modal-header">
        <h3 class="h5 mb-0" id="examHistoryTitle">Seleziona traccia</h3>
        <button class="btn btn-outline-secondary btn-icon btn-sm" type="button" id="examHistoryClose" aria-label="Chiudi">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="template-status text-secondary" id="mappingStatus">Nessuna traccia selezionata.</div>
        <div class="text-secondary small" id="examInfo"></div>
        <details class="session-panel">
          <summary>Sessioni di correzione</summary>
          <div class="session-panel-body">
            <label class="field">
              <span>Sessione</span>
              <select id="sessionSelect" class="form-select"></select>
            </label>
            <button class="btn btn-outline-secondary" id="newSession" type="button">
              <i class="fa-solid fa-plus"></i>
              Nuova sessione
            </button>
          </div>
        </details>
        <div id="examHistory" class="exam-grid"></div>
      </div>
    </div>

    <div class="modal-backdrop is-hidden" id="clearResultsBackdrop"></div>
    <div class="modal-panel is-hidden" id="clearResultsModal" role="dialog" aria-modal="true" aria-labelledby="clearResultsTitle">
      <div class="modal-header">
        <h3 class="h5 mb-0" id="clearResultsTitle">Conferma</h3>
        <button class="btn btn-outline-secondary btn-icon btn-sm" type="button" id="clearResultsClose" aria-label="Chiudi">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="modal-body">
        <p>Sei sicuro di voler svuotare tutti i risultati?</p>
        <div class="actions">
          <button class="btn btn-outline-secondary" type="button" id="clearResultsCancel">Annulla</button>
          <button class="btn btn-danger" type="button" id="confirmClearResults">Svuota registro</button>
        </div>
      </div>
    </div>

    <!-- Prompt Test Modal -->
    <div class="modal-backdrop is-hidden" id="promptTestBackdrop"></div>
    <div class="modal-panel is-hidden" id="promptTestModal" role="dialog" aria-modal="true" aria-labelledby="promptTestTitle" style="max-width: 800px;">
      <div class="modal-header">
        <h3 class="h5 mb-0" id="promptTestTitle">Prompt per LLM - Test</h3>
        <button class="btn btn-outline-secondary btn-icon btn-sm" type="button" id="promptTestClose" aria-label="Chiudi">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="text-secondary small mb-2">Questo prompt pu√≤ essere inviato a un LLM per generare consigli di studio personalizzati.</div>
        <pre id="promptTestContent" style="white-space: pre-wrap; max-height: 500px; overflow-y: auto; background: #f8f9fa; padding: 1rem; border-radius: 4px; font-size: 0.85rem;"></pre>
        <div class="mt-3">
          <button class="btn btn-outline-primary btn-sm" type="button" id="copyPromptBtn">
            <i class="fa-solid fa-copy"></i> Copia prompt
          </button>
        </div>
      </div>
    </div>

    <!-- Teaching Improvement Prompt Modal -->
    <div class="modal-backdrop is-hidden" id="teachingPromptBackdrop"></div>
    <div class="modal-panel is-hidden" id="teachingPromptModal" role="dialog" aria-modal="true" aria-labelledby="teachingPromptTitle" style="max-width: 900px;">
      <div class="modal-header">
        <h3 class="h5 mb-0" id="teachingPromptTitle">Prompt AI - Consigli Didattici</h3>
        <button class="btn btn-outline-secondary btn-icon btn-sm" type="button" id="teachingPromptClose" aria-label="Chiudi">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="text-secondary small mb-2">
          Questo prompt analizza i risultati complessivi dell'esame e fornisce consigli al professore su come migliorare l'insegnamento.
          Copia il prompt e invialo a un LLM (ChatGPT, Claude, ecc.) per ottenere suggerimenti didattici personalizzati.
        </div>
        <pre id="teachingPromptContent" style="white-space: pre-wrap; max-height: 500px; overflow-y: auto; background: #f8f9fa; padding: 1rem; border-radius: 4px; font-size: 0.85rem;"></pre>
        <div class="mt-3">
          <button class="btn btn-outline-primary btn-sm" type="button" id="copyTeachingPromptBtn">
            <i class="fa-solid fa-copy"></i> Copia prompt
          </button>
        </div>
      </div>
    </div>

    <!-- <footer class="footer">
      <p>Salvataggio locale nel browser. Nessun dato lascia il computer.</p>
    </footer> -->

    <div class="toast-notify" id="gradingToast" role="status" aria-live="polite"></div>
    <% } %>

    <script
      defer
      src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"
    ></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js"
    ></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/latex.js/dist/latex.min.js"
    ></script>
    <script src="exam-cards.js"></script>
    <script src="app.js"></script>
  </body>
</html>
